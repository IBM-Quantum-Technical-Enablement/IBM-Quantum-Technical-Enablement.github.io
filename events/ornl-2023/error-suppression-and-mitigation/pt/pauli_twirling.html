

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Background &#8212; Enabing Technologies  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/thebelab-helper.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-16824831-8"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-16824831-8');
            </script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'events/ornl-2023/error-suppression-and-mitigation/pt/pauli_twirling';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>

<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../../explore/atom.xml"
  title="Quantum Explorations"
/>



  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the site..."
         aria-label="Search the site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../../_static/dark_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../how-to/howto.html">
                        How to guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../explore.html">
                        Explorations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../hardware/hardware.html">
                        IBM Hardware
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../events.html">
                        Events
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../members.html">
                        Contributors
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the site..."
         aria-label="Search the site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/IBM-Quantum-Technical-Enablement" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../how-to/howto.html">
                        How to guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../explore.html">
                        Explorations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../hardware/hardware.html">
                        IBM Hardware
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../events.html">
                        Events
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../members.html">
                        Contributors
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the site..."
         aria-label="Search the site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/IBM-Quantum-Technical-Enablement" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Background</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
<section class="tex2jax_ignore mathjax_ignore" id="background">
<h1>Background<a class="headerlink" href="#background" title="Permalink to this heading">#</a></h1>
<p>Pauli-twirling is a quantum error suppression technique that uses randomization to noise shape coherent error into stochastic errors, by combining the results from many random, but logically equivalent circuits, together. This is beneficial because while incoherent errors add up linearly with circuit depth, coherent errors can scale quadratically. Here we will show how to generate Pauli-twirled circuits, where we focus on twirling two-qubit gates within a circuit. This technique has been used, for example, in this work by Kim et al.: arXiv:2108.09197. We will show how to compute the possible Pauli sets for any two-qubit gate, and show how to create a Qiskit <code class="docutils literal notranslate"><span class="pre">Passmanager</span></code> that implements the routine, and can be combined with other transpilation techniques.</p>
<p><img alt="benefit_of_twirling.png" src="../../../../_images/benefit_of_twirling.png" /><br />
Credits: Zlatko Minev, IBM Quantum (https://www.zlatko-minev.com/blog/twirling)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># Need gate classes for generating the Pauli twirling sets</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.library</span> <span class="kn">import</span> <span class="p">(</span><span class="n">IGate</span><span class="p">,</span> <span class="n">XGate</span><span class="p">,</span> <span class="n">YGate</span><span class="p">,</span> <span class="n">ZGate</span><span class="p">,</span>
                                    <span class="n">CXGate</span><span class="p">,</span> <span class="n">CZGate</span><span class="p">,</span> <span class="n">ECRGate</span><span class="p">,</span> <span class="n">iSwapGate</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">qiskit.quantum_info</span> <span class="kn">import</span> <span class="n">Operator</span>
<span class="c1"># Classes for building up a directed-acyclic graph (DAG) structure</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit</span> <span class="kn">import</span> <span class="n">QuantumRegister</span>
<span class="kn">from</span> <span class="nn">qiskit.dagcircuit</span> <span class="kn">import</span> <span class="n">DAGCircuit</span>
<span class="c1"># Transpiler stuff neded to make a pass and passmanager</span>
<span class="kn">from</span> <span class="nn">qiskit.transpiler</span> <span class="kn">import</span> <span class="n">PassManager</span>
<span class="kn">from</span> <span class="nn">qiskit.transpiler.basepasses</span> <span class="kn">import</span> <span class="n">TransformationPass</span>
<span class="kn">from</span> <span class="nn">qiskit.transpiler.passes</span> <span class="kn">import</span> <span class="n">Optimize1qGatesDecomposition</span>

<span class="c1"># A fake system to transpile against</span>
<span class="kn">from</span> <span class="nn">qiskit.providers.fake_provider</span> <span class="kn">import</span> <span class="n">FakeHanoiV2</span><span class="p">,</span> <span class="n">FakeMumbai</span>
<span class="kn">from</span> <span class="nn">qiskit.quantum_info</span> <span class="kn">import</span> <span class="n">SparsePauliOp</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="setup-test-circuit-and-backend">
<h1>Setup: test circuit and backend<a class="headerlink" href="#setup-test-circuit-and-backend" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create Circuit</span>
<span class="k">def</span> <span class="nf">create_ghz_circuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
    <span class="n">ghz_circuit</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">ghz_circuit</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">qubit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">ghz_circuit</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qubit</span><span class="p">)</span>

    <span class="n">ghz_circuit</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
    <span class="n">ghz_circuit</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">ghz_circuit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">circuit</span> <span class="o">=</span> <span class="n">create_ghz_circuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">=</span><span class="n">num_qubits</span><span class="p">)</span>
<span class="n">operator</span> <span class="o">=</span> <span class="n">SparsePauliOp</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="o">*</span><span class="n">num_qubits</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span> <span class="o">=</span> <span class="n">FakeHanoiV2</span><span class="p">()</span>
<span class="n">transpiled_circuit</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">optimization_level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="pt-circuit-transformation">
<h1>PT Circuit transformation<a class="headerlink" href="#pt-circuit-transformation" title="Permalink to this heading">#</a></h1>
<p><img alt="twirling_2q_gates.svg" src="../../../../_images/twirling_2q_gates.svg" /></p>
<section id="computing-pauli-twirling-gate-sets">
<h2>Computing Pauli twirling gate sets<a class="headerlink" href="#computing-pauli-twirling-gate-sets" title="Permalink to this heading">#</a></h2>
<p>As the name suggests, we are going to look at using single qubit Pauli operators to reshape the noise in our circuits. Because the bulk of the error in a circuit resides with the two-qubit gates, here we focus on Pauli twirling two-qubit gates only.</p>
<p>We are looking for sets of 4 Pauli gates that when pre-pended and appended to a circuit containing a two-qubit gate, the unitary is equal to that of the single two-qubit gate alone. This makes sense of course, as otherwise our circuit would not do what we want it to. We now need to figure out which combinations of Pauli gates satisfies this requirement. IBM Quantum systems have 3 different two-qubit entangling gates: CNOT, CZ, and ECR, and the corresponding Pauli combinations are obviously going to depend on which gate we are looking at. Now for common gates like CNOT, one can find tables of Paulis in the literature. However, for a gate like ECR, I am not sure such a table exists. We could compute these by hand, but here we are going to be smarter and let the computer do all the work for us.</p>
<p>First, let us generate some instances of the Pauli gates, as well as a collection of 2Q gates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Single qubit Pauli gates</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">IGate</span><span class="p">()</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">ZGate</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">XGate</span><span class="p">()</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">YGate</span><span class="p">()</span>

<span class="c1"># 2Q entangling gates</span>
<span class="n">CX</span> <span class="o">=</span> <span class="n">CXGate</span><span class="p">()</span>
<span class="n">CZ</span> <span class="o">=</span> <span class="n">CZGate</span><span class="p">()</span>
<span class="n">ECR</span> <span class="o">=</span> <span class="n">ECRGate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now let us put the computer to work finding all possible combinations of Paulis that leave the action of a two-qubit gate unchanged, up to a phase factor. Below we create a function that takes a Qiskit two-qubit gate as the input, and finds all the Pauli combinations by treating it as a 16 choose 4 problem, and letting Python generate all the possibilities. If the unitary remains unchanged, then we add the combination of Paulis to the output list, along with a phase value of Zero. However, if the unitaries differ by a phase factor of <span class="math notranslate nohighlight">\(\pi\)</span>, we add a global phase of <span class="math notranslate nohighlight">\(\pi\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_pauli_twirling_sets</span><span class="p">(</span><span class="n">two_qubit_gate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the Pauli twirling sets for a given 2Q gate</span>
<span class="sd">    </span>
<span class="sd">    Sets are ordered such that gate[0] and gate[1] are pre-roations</span>
<span class="sd">    applied to control and target, respectively.  gate[2] and gate[3]</span>
<span class="sd">    are post-rotations for control and target, respectively.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        two_qubit_gate (Gate): Input two-qubit gate</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        list: List of all twirling gate sets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pauli_gates_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]</span>
    <span class="c1"># This is the target unitary to which our twirled circuit should match</span>
    <span class="n">target_unitary</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">(</span><span class="n">two_qubit_gate</span><span class="o">.</span><span class="n">to_matrix</span><span class="p">())</span>
    <span class="n">twirling_sets</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># For every combination in 16 choose 4 make a circuit and look for equivilence</span>
    <span class="k">for</span> <span class="n">gates</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">pauli_gates_list</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="c1"># Build a circuit for our twirled 2Q gate</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">two_qubit_gate</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gates</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gates</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Operator</span><span class="o">.</span><span class="n">from_circuit</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span><span class="o">-</span><span class="n">target_unitary</span><span class="p">)</span>
        
        <span class="n">phase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># If unitaries match we have a phase of zero</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># If unitaries differ by a phase of pi, shift by pi</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">norm</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">global_phase</span> <span class="o">+=</span> <span class="n">phase</span>
            <span class="c1"># Verify that our twirled circuit is a valid replacement</span>
            <span class="k">assert</span> <span class="n">Operator</span><span class="o">.</span><span class="n">from_circuit</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span> <span class="o">==</span> <span class="n">target_unitary</span>
            <span class="n">twirl_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">gates</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
            <span class="c1"># Check that set does not already exist</span>
            <span class="k">if</span> <span class="n">twirl_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">twirling_sets</span><span class="p">:</span>
                <span class="n">twirling_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twirl_set</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">twirling_sets</span>
</pre></div>
</div>
</div>
</div>
<p>With this function in hand, we are now in a position to generate the Pauli twirling sets for any two-qubit gate that Qiskit understands. Here we generate the sets for each of the two-qubit gate instances above. In preparation for using them later, we store the sets in a dictionary with the gate name as the key. In practice you should do this once, and then cache / hard-code the results for fast retrieval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">twirling_groups</span> <span class="o">=</span> <span class="p">{}</span> 

<span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CX</span><span class="p">,</span> <span class="n">CZ</span><span class="p">,</span> <span class="n">ECR</span><span class="p">]:</span>
    <span class="n">twirl_set</span> <span class="o">=</span> <span class="n">generate_pauli_twirling_sets</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
    <span class="n">twirling_groups</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">twirl_set</span>
</pre></div>
</div>
</div>
</div>
<p>For example, here is the set for the CNOT (CX) gate. We see that two of the twirling sets have a non-zero phase factor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">twirling_groups</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[((Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[])),
  3.141592653589793),
 ((Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;id&#39;, num_qubits=1, num_clbits=0, params=[])),
  0),
 ((Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;y&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;x&#39;, num_qubits=1, num_clbits=0, params=[]),
   Instruction(name=&#39;z&#39;, num_qubits=1, num_clbits=0, params=[])),
  3.141592653589793)]
</pre></div>
</div>
</div>
</div>
<section id="twirling-qiskit-circuits">
<h3>Twirling Qiskit circuits<a class="headerlink" href="#twirling-qiskit-circuits" title="Permalink to this heading">#</a></h3>
<p>With our twirling sets in hand, we are now in a position to apply Pauli twirling to a given circuit. Pauli twirling is a circuit transformation and thus is best utilized as a transpilation pass. Below is a pass called <code class="docutils literal notranslate"><span class="pre">PauliTwirling</span></code> that performs twirling on a specific two-qubit gate, and utilizes the dictionary of twirling sets that we generated above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PauliTwirling</span><span class="p">(</span><span class="n">TransformationPass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pauli twirl an input circuit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">twirling_gate</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            twirling_gate (str): Which gate to twirl</span>
<span class="sd">            seed (int): Seed for RNG, should be &lt; 2e32</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># This is the target gate to twirl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twirling_gate</span> <span class="o">=</span> <span class="n">twirling_gate</span>
        <span class="c1"># Get the twirling set from the dict we generated above</span>
        <span class="c1"># This should be repalced by a cached version in practice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twirling_set</span> <span class="o">=</span> <span class="n">twirling_groups</span><span class="p">[</span><span class="n">twirling_gate</span><span class="p">]</span>
        <span class="c1"># Length of the twirling set to bound RNG generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twirling_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">twirling_set</span><span class="p">)</span>
        <span class="c1"># Seed the NumPy RNG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert Pauli twirls into input DAG</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">            dag (DAGCircuit): Input DAG</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dag: DAG with twirls added in-place</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">collect_runs</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">twirling_gate</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">run</span><span class="p">:</span>
                <span class="c1"># Generate a random int to specify the twirling gates</span>
                <span class="n">twirl_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">twirling_len</span><span class="p">)</span>
                <span class="c1"># Get the randomly selected twirling set</span>
                <span class="n">twirl_gates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">twirling_set</span><span class="p">[</span><span class="n">twirl_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">twirl_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">twirling_set</span><span class="p">[</span><span class="n">twirl_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Make a small DAG for the twirled circuit we are going to insert</span>
                <span class="n">twirl_dag</span> <span class="o">=</span> <span class="n">DAGCircuit</span><span class="p">()</span>
                <span class="c1"># Add a register of qubits (here always 2Q)</span>
                <span class="n">qreg</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">add_qreg</span><span class="p">(</span><span class="n">qreg</span><span class="p">)</span>
                <span class="c1"># gate[0] pre-applied to control</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">apply_operation_back</span><span class="p">(</span><span class="n">twirl_gates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">qreg</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="c1"># gate[1] pre-applied to target</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">apply_operation_back</span><span class="p">(</span><span class="n">twirl_gates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">qreg</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># Insert original gate</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">apply_operation_back</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="p">[</span><span class="n">qreg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qreg</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># gate[2] pre-applied to control</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">apply_operation_back</span><span class="p">(</span><span class="n">twirl_gates</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">qreg</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="c1"># gate[3] pre-applied to target</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">apply_operation_back</span><span class="p">(</span><span class="n">twirl_gates</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="n">qreg</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># Add a global phase gate to account for possible phase difference</span>
                <span class="n">twirl_dag</span><span class="o">.</span><span class="n">global_phase</span> <span class="o">+=</span> <span class="n">twirl_phase</span>
                <span class="c1"># Replace the target gate with the twirled version</span>
                <span class="n">dag</span><span class="o">.</span><span class="n">substitute_node_with_dag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">twirl_dag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dag</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span> <span class="o">=</span> <span class="n">PassManager</span><span class="p">([</span><span class="n">PauliTwirling</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">54321</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<p>We suggest always twirl a <em>transpiled</em> circuit as an input circuit is written using most convenient gates, e.g., 3+ qubit gates, non-basis gates, etc. When the gates do not match the two-qubit basis gate of the system, we need to transpile first, and then twirl.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">twirl_qc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transpiled_circuit</span><span class="p">)</span>
<span class="n">twirl_qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/518548a0df06daaeeffb76c63e70a436bb62b697b770c1b37ea54be4a7874d8a.png" src="../../../../_images/518548a0df06daaeeffb76c63e70a436bb62b697b770c1b37ea54be4a7874d8a.png" />
</div>
</div>
<p>The twirled circuit can be further optimized in terms of single qubit gates. As such, we construct as new Passmanager that does the Pauli twirling, and then performs single-qubit gate optimization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_pm</span> <span class="o">=</span> <span class="n">PassManager</span><span class="p">([</span><span class="n">PauliTwirling</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">54321</span><span class="p">),</span> 
                       <span class="n">Optimize1qGatesDecomposition</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">operation_names</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_twirl_qc</span> <span class="o">=</span> <span class="n">post_pm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transpiled_circuit</span><span class="p">)</span>
<span class="n">post_twirl_qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/6418f47dce108030dcc0b0859ba8307f675a5fbe56de46505f22b9be24ed2c92.png" src="../../../../_images/6418f47dce108030dcc0b0859ba8307f675a5fbe56de46505f22b9be24ed2c92.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_twirls</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">twirl_qc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">post_pm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transpiled_circuit</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_twirls</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">twirl_qc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/ea452dede59c8be97bd1f30a4a7b0eebd2fbcfad5746091c75769afac379dd5b.png" src="../../../../_images/ea452dede59c8be97bd1f30a4a7b0eebd2fbcfad5746091c75769afac379dd5b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">twirl_qc_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/064fd079b55754ad3735427e01eb828f62ed300d616dc8df8b3b3dfa100eba03.png" src="../../../../_images/064fd079b55754ad3735427e01eb828f62ed300d616dc8df8b3b3dfa100eba03.png" />
</div>
</div>
</section>
</section>
<section id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Permalink to this heading">#</a></h2>
<p>When twirling, the number of shots per circuit is usually reduced. That is to say that, if before you ran one circuit 10000 times, then you can try executing 10 twirled circuits with 1000 shots each, or 100 circuits at 100 shots, etc. Keep in mind that the IBM Quantum infrastructure is optimized for many shots per circuit, and therefore it will take longer to run more circuits at fewer shots. But, if you want to try to improve your results, it might be a trade-off worth making.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shots_per_twirl</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">twirl_qc_list</span><span class="p">)</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">twirl_qc_list</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots_per_twirl</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="result-post-processing">
<h2>Result Post-processing<a class="headerlink" href="#result-post-processing" title="Permalink to this heading">#</a></h2>
<p>Post-processing for Pauli Twirling involves <em>aggregating</em> the results. It can be aggregating the <code class="docutils literal notranslate"><span class="pre">Counts</span></code> dictionaries or averaging the probability distribution across many twirls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to aggregate data from many twirls.</span>
<span class="sd">    When `normalize=False`, it adds `values` per `key` across all twirls.</span>
<span class="sd">    When `normalize=True`, it averages `values` per `key` across all twirls.</span>
<span class="sd">    For (quasi) probability distributions, we should normalize (average) the aggregated probabilities.</span>
<span class="sd">    </span>
<span class="sd">    Example-1: Consider `Counts` for 3 twirls: {&#39;0&#39;: 400, &#39;1&#39;: 600}, {&#39;0&#39;: 500, &#39;1&#39;: 500}, {&#39;0&#39;: 600, &#39;1&#39;: 400}.</span>
<span class="sd">    After aggregation (with `normalize=False`), it will return a single aggregated dictionary {&#39;0&#39;: 1500, &#39;1&#39;: 1500}.</span>
<span class="sd">    </span>
<span class="sd">    Example-2: Consider quasi distribution for 3 twirls: {&#39;0&#39;: 0.4, &#39;1&#39;: 0.6}, {&#39;0&#39;: 0.5, &#39;1&#39;: 0.5}, {&#39;0&#39;: 0.6, &#39;1&#39;: 0.4}.</span>
<span class="sd">    After aggregation (with `normalize=True`), it will return a single aggregated dictionary</span>
<span class="sd">    {&#39;0&#39;: (0.4+0.5+0.6)/3, &#39;1&#39;: (0.6+0.5+0.4)/3} = {&#39;0&#39;: 0.5, &#39;1&#39;: 0.5}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="mi">1</span>
    
    <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
            <span class="n">aggregated</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="n">total</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">aggregated</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts_agg</span> <span class="o">=</span> <span class="n">aggregate_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">counts</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">twirl_qc_list</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counts twirl-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Counts twirl-0: {&#39;000&#39;: 1576, &#39;111&#39;: 1633, &#39;010&#39;: 16, &#39;101&#39;: 23, &#39;100&#39;: 34, &#39;011&#39;: 21, &#39;110&#39;: 12, &#39;001&#39;: 18}
Counts twirl-1: {&#39;000&#39;: 1603, &#39;111&#39;: 1623, &#39;100&#39;: 32, &#39;001&#39;: 20, &#39;101&#39;: 16, &#39;011&#39;: 23, &#39;010&#39;: 8, &#39;110&#39;: 8}
Counts twirl-2: {&#39;111&#39;: 1591, &#39;000&#39;: 1626, &#39;101&#39;: 23, &#39;100&#39;: 28, &#39;110&#39;: 17, &#39;010&#39;: 21, &#39;011&#39;: 17, &#39;001&#39;: 10}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aggregated counts </span><span class="si">{</span><span class="n">counts_agg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>aggregated counts {&#39;000&#39;: 4805.0, &#39;111&#39;: 4847.0, &#39;010&#39;: 45.0, &#39;101&#39;: 62.0, &#39;100&#39;: 94.0, &#39;011&#39;: 61.0, &#39;110&#39;: 37.0, &#39;001&#39;: 48.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;numpy version </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">qiskit_ibm_runtime</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;qiskit runtime version </span><span class="si">{</span><span class="n">qiskit_ibm_runtime</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">get_version_info</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">qiskit.tools.jupyter</span>
<span class="o">%</span><span class="k">qiskit_version_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy version 1.23.5
qiskit runtime version 0.11.2
</pre></div>
</div>
<div class="output text_html"><h3>Version Information</h3><table><tr><th>Qiskit Software</th><th>Version</th></tr><tr><td><code>qiskit-terra</code></td><td>0.24.1</td></tr><tr><td><code>qiskit-aer</code></td><td>0.12.0</td></tr><tr><td><code>qiskit-ibmq-provider</code></td><td>0.20.2</td></tr><tr><td><code>qiskit</code></td><td>0.43.1</td></tr><tr><th>System information</th></tr><tr><td>Python version</td><td>3.10.11</td></tr><tr><td>Python compiler</td><td>MSC v.1934 64 bit (AMD64)</td></tr><tr><td>Python build</td><td>main, May 10 2023 18:51:25</td></tr><tr><td>OS</td><td>Windows</td></tr><tr><td>CPUs</td><td>8</td></tr><tr><td>Memory (Gb)</td><td>63.71001434326172</td></tr><tr><td colspan='2'>Sat Jul 15 19:55:49 2023 Eastern Daylight Time</td></tr></table></div></div>
</div>
</section>
</section>

<div class="section ablog__blog_comments">
  
  
</div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Background</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-test-circuit-and-backend">Setup: test circuit and backend</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-circuit-transformation">PT Circuit transformation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-pauli-twirling-gate-sets">Computing Pauli twirling gate sets</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#twirling-qiskit-circuits">Twirling Qiskit circuits</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execution">Execution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#result-post-processing">Result Post-processing</a></li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../../../../_sources/events/ornl-2023/error-suppression-and-mitigation/pt/pauli_twirling.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

<footer class="bd-footer">
<div>
<p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Content on
        <a property="dct:title" rel="cc:attributionURL" href="http://quantum-enablement.org">this website</a> 
        by <span property="cc:attributionName">IBM</span> is licensed under 
        <a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
                Attribution-NonCommercial 4.0 International<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1">
                <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1">
                <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1">
        </a>
</p> 
</div>
</footer>

  </body>
</html>