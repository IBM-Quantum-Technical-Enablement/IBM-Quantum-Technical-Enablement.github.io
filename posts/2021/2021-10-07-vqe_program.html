
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Custom VQE Program for Qiskit Runtime &#8212; Enabing Technologies  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.google-analytics.com/analytics.js"></script>
    <script>
                window.ga = window.ga || function () {
                    (ga.q = ga.q || []).push(arguments) };
                ga.l = +new Date;
                ga('create', 'UA-16824831-8', 'auto');
                ga('set', 'anonymizeIp', true);
                ga('send', 'pageview');
            </script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="None"> 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../blog/atom.xml"
  title="Paul Nation's Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../../_static/dark_logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../blog.html">
  Explorations
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../members.html">
  Members
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the site..." aria-label="Search the site..." autocomplete="off" >
</form>
      </div>
      
      <div class="navbar-end-item">
        <span id="theme-switch" class="btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/IBM-Quantum-Technical-Enablement" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items">  
<h2>
   <i class="fa fa-calendar"></i>
  07 October 2021 
</h2>

<ul>
      
<li id="category">
  <span
    ><i class="fa-fw fa fa-folder-open"></i></span
  >
   
  <a href="../../blog/category/runtime.html">Runtime</a>  
</li>
 
<li id="tags">
  <span
    ><i
      class="fa-fw fa fa-tag"
    ></i
    ></span
  >
   
  <a href="../../blog/tag/custom.html">Custom</a>  
</li>
 
</ul>
<div class="dropdown-buttons">
    <!-- ipynb file if we had a myst markdown file -->
    
    <!-- Download raw file -->
    <a class="dropdown-buttons" href="../../_sources/posts/2021/2021-10-07-vqe_program.ipynb.txt"><button type="button"
            class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
            data-placement="left">.ipynb</button></a>
</div>
<h3>
  <a href="../../blog.html">Recent Posts</a>
</h3>
<ul>
   
  <li>
    <a href="2021-12-20-qrng.html"
      >20 December - Pitfalls in generating random numbers on quantum computers</a
    >
  </li>
  
  <li>
    <a href="2021-12-20-esp_readout.html"
      >20 December - Excited State Promotion (ESP) Readout</a
    >
  </li>
  
  <li>
    <a href="2021-11-28-falcon_r5.html"
      >28 November - Comparison of Falcon R5 processors verse R4</a
    >
  </li>
  
  <li>
    <a href="2021-10-31-best_swap_mapper_qiskit.html"
      >31 October - Choosing the best Qiskit swap mapper</a
    >
  </li>
  
  <li>
    <a href="2021-10-27-dynamic_BV.html"
      >27 October - Dynamic Bernstein-Vazirani using mid-circuit reset and measurement</a
    >
  </li>
  
</ul>

<h3>
  <a href="../../blog/archive.html">Archives</a>
</h3>
<ul>
   
  <li>
    <a href="../../blog/2021.html">2021 (7)</a>
  </li>
   
</ul>

  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
    
    <div class="toc-item">
      
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#current-limitations">
   Current limitations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simple-vqe">
   Simple VQE
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#specifying-the-form-of-the-input-values">
   Specifying the form of the input values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optionals">
     Optionals
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#main-program">
   Main program
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#required-signature">
     Required signature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-main-vqe-program">
     The main VQE program
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-testing">
   Local testing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#program-metadata">
   Program metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#uploading-the-program">
   Uploading the program
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#program-upload">
     Program upload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#program-information">
     Program information
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deleting-a-program">
     Deleting a program
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-the-program">
   Running the program
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-parameters">
     Specify parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#execute-the-program">
     Execute the program
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#listening-for-interim-results">
     Listening for interim results
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#formatting-the-returned-results">
     Formatting the returned results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simplifying-program-execution-with-wrapping-functions">
   Simplifying program execution with wrapping functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-a">
   Appendix A
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-b">
   Appendix B
  </a>
 </li>
</ul>

</nav>
    </div>
    
    <div class="toc-item">
      
    </div>
    
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                 <section class="tex2jax_ignore mathjax_ignore" id="custom-vqe-program-for-qiskit-runtime">
<h1>Custom VQE Program for Qiskit Runtime<a class="headerlink" href="#custom-vqe-program-for-qiskit-runtime" title="Permalink to this headline">#</a></h1>
<p>Here we will demonstrate how to create, upload, and use a custom Program for Qiskit Runtime.  As the utility of the Runtime execution engine lies in its ability to execute many quantum circuits with low latencies, this tutorial will show how to create your own Variational Quantum Eigensolver (VQE) program from scratch.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>You must have Qiskit 0.30+ installed.</p></li>
<li><p>You must have an IBM Quantum account with the ability to upload a runtime program.  You have this ability if you belong to more than one provider.</p></li>
</ul>
</section>
<section id="current-limitations">
<h2>Current limitations<a class="headerlink" href="#current-limitations" title="Permalink to this headline">#</a></h2>
<p>The runtime execution engine currently has the following limitations that must be kept in mind:</p>
<ul class="simple">
<li><p>The Docker images used by the runtime include only Qiskit and its dependencies, with few exceptions.  One exception is the inclusion of the <code class="docutils literal notranslate"><span class="pre">mthree</span></code> measurement mitigation package.</p></li>
<li><p>For security reasons, the runtime cannot make internet calls outside of the environment.</p></li>
<li><p>Your runtime program name must not contain an underscore<code class="docutils literal notranslate"><span class="pre">_</span></code>, otherwise it will cause an error when you try to execute it.</p></li>
</ul>
<p>As Qiskit Runtime matures, these limitations will be removed.</p>
</section>
<section id="simple-vqe">
<h2>Simple VQE<a class="headerlink" href="#simple-vqe" title="Permalink to this headline">#</a></h2>
<p>VQE is an hybrid quantum-classical optimization procedure that finds the lowest eigenstate and eigenenergy of a linear system defined by a given Hamiltonian of Pauli operators.  For example, consider the following two-qubit Hamiltonian:</p>
<div class="math notranslate nohighlight">
\[
H = A X_{1}\otimes X_{0} + A Y_{1}\otimes Y_{0} + A Z_{1}\otimes Z_{0},
\]</div>
<p>where <span class="math notranslate nohighlight">\(A\)</span> is numerical coefficient and the subscripts label the qubits on which the operators act.  The zero index being farthest right is the ordering used in Qiskit.  The Pauli operators tell us which measurement basis to to use when measuring each of the qubits.</p>
<p>We want to find the ground state (lowest energy state) of this Hamiltonian, and the associated eigenvector.  To do this we must start at a given initial state and iteratively vary the parameters that define this state using a classical optimizer, such that the computed energies of subsequent steps are nominally lower than those previously.  The parameterized state of the system is defined by an ansatz quantum circuit that should have non-zero support in the direction of the ground state.  Because in general we do not know the solution, the choice of ansatz circuit can be highly problem-specific with a form dictated by additional information. For further information about variational algorithms, we point the reader to <a class="reference external" href="https://doi.org/10.1038/s42254-021-00348-9">Nature Reviews Physics volume 3, 625 (2021)</a>.</p>
<p>Thus we need at least the following inputs to create our VQE quantum program:</p>
<ol class="arabic simple">
<li><p>A representation of the Hamiltonian that specifies the problem.</p></li>
<li><p>A choice of parameterized ansatz circuit, and the ability to pass configuration options, if any.</p></li>
</ol>
<p>However, the following are also beneficial inputs that users might want to have:</p>
<ol class="arabic simple" start="3">
<li><p>Add the ability to pass an initial state.</p></li>
<li><p>Vary the number of shots that are taken.</p></li>
<li><p>Ability to select which classical optimizer is used, and set configuraton values, if any.</p></li>
<li><p>Ability to turn on and off measurement mitigation.</p></li>
</ol>
</section>
<section id="specifying-the-form-of-the-input-values">
<h2>Specifying the form of the input values<a class="headerlink" href="#specifying-the-form-of-the-input-values" title="Permalink to this headline">#</a></h2>
<p>All inputs to runtime programs must be serializable objects.  That is to say, whatever you pass into a runtime program must be able to be converted to JSON format.  It is thus beneficial to keep inputs limited to basic data types and structures unless you have experience with custom object serialization, or they are common Qiskit types such as <code class="docutils literal notranslate"><span class="pre">QuantumCircuit</span></code> etc that the built-in <code class="docutils literal notranslate"><span class="pre">RuntimeEncoder</span></code> can handle.  Fortunately, the VQE program described above can be made out of simple Python components.</p>
<p>First, it is possible to represent any Hamiltonian using a list of values with each containing the numerical coefficeint for each term and the string representation for the Pauli operators.  For the above example, the ground state energy with <span class="math notranslate nohighlight">\(A=1\)</span> is <span class="math notranslate nohighlight">\(-3\)</span> and we can write it as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">H</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;XX&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;YY&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ZZ&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Next we have to provide the ability to specify the parameterized Ansatz circuit.  Here we will take advange of the fact that many ansatz circuits are pre-defined in the Qiskit Circuit Library.  Examples can be found in the <a class="reference external" href="https://qiskit.org/documentation/apidoc/circuit_library.html#n-local-circuits">N-local circuits section</a>.</p>
<p>We would like the user to be able to select between ansatz options such as: <code class="docutils literal notranslate"><span class="pre">NLocal</span></code>, <code class="docutils literal notranslate"><span class="pre">TwoLocal</span></code>, and <code class="docutils literal notranslate"><span class="pre">EfficientSU2</span></code>.  We could have the user pass the whole ansatz circuit to the program; however, in order to reduce the size of the upload we will pass the ansatz by name.  In the runtime program, we can take this name and get the class that it corresponds to from the library using, for example,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">qiskit.circuit.library.n_local</span> <span class="k">as</span> <span class="nn">lib_local</span>

<span class="n">ansatz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lib_local</span><span class="p">,</span> <span class="s1">&#39;EfficientSU2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For the ansatz configuration, we will pass a simple <code class="docutils literal notranslate"><span class="pre">dict</span></code> of values.</p>
<section id="optionals">
<h3>Optionals<a class="headerlink" href="#optionals" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>If we want to add the ability to pass an initial state, then we will need to add the ability to pass a 1D list/ NumPy array.  Because the number of parameters depends on the ansatz and its configuration, the user would have to know what ansatz they are doing ahead of time.</p></li>
<li><p>Selecting a number of shots requires simply passing an integer value.</p></li>
<li><p>Here we will allow selecting a classical optimizer by name from those in SciPy, and a <code class="docutils literal notranslate"><span class="pre">dict</span></code> of configuration parameters.  Note that for execution on an actual system, the noise inherent in todayâ€™s quantum systems makes having a stochastic optimizer crucial to success.  SciPy does not have such a choice, and the one built into Qiskit is wrapped in such a manner as to make it difficult to use elsewhere.  As such, here we will use an SPSA optimizer written to match the style of those in SciPy.  This function is given in <span class="xref myst">Appendix A</span>.</p></li>
</ul>
<ul class="simple">
<li><p>Finally, for measurement error mitigation we can simply pass a boolean (True/False) value.</p></li>
</ul>
</section>
</section>
<section id="main-program">
<h2>Main program<a class="headerlink" href="#main-program" title="Permalink to this headline">#</a></h2>
<p>We are now in a position to start building our main program.  However, before doing so we point out that it makes the code cleaner to make a separate fuction that takes strings of Pauli operators that define our Hamiltonian and convert them to a list of circuits with single-qubit gates that change the measurement basis for each qubit, if needed. This function is given in <span class="xref myst">Appendix B</span>.</p>
<section id="required-signature">
<h3>Required signature<a class="headerlink" href="#required-signature" title="Permalink to this headline">#</a></h3>
<p>Every runtime program is defined via the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, and must have the following input signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">user_message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">backend</span></code> is the backend that the program is to be executed on, and <code class="docutils literal notranslate"><span class="pre">user_message</span></code> is the class by which interim (and possibly final) results are communicated back to the user.  After these two items, we add our program-specific arguments and keyword arguments.</p>
</section>
<section id="the-main-vqe-program">
<h3>The main VQE program<a class="headerlink" href="#the-main-vqe-program" title="Permalink to this headline">#</a></h3>
<p>Here is the main program for our sample VQE.  What each element of the function does is written in the comments before the element appears.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grab functions and modules from dependencies</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>
<span class="kn">import</span> <span class="nn">mthree</span>

<span class="c1"># Grab functions and modules from Qiskit needed</span>
<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">transpile</span>
<span class="kn">import</span> <span class="nn">qiskit.circuit.library.n_local</span> <span class="k">as</span> <span class="nn">lib_local</span>

<span class="c1"># The entrypoint for our Runtime Program</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">user_messenger</span><span class="p">,</span>
         <span class="n">hamiltonian</span><span class="p">,</span>
         <span class="n">ansatz</span><span class="o">=</span><span class="s1">&#39;EfficientSU2&#39;</span><span class="p">,</span>
         <span class="n">ansatz_config</span><span class="o">=</span><span class="p">{},</span>
         <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;SPSA&#39;</span><span class="p">,</span>
         <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
         <span class="n">shots</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
         <span class="n">use_measurement_mitigation</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main sample VQE program.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        backend (ProgramBackend): Qiskit backend instance.</span>
<span class="sd">        user_messenger (UserMessenger): Used to communicate with the</span>
<span class="sd">                                        program user.</span>
<span class="sd">        hamiltonian (list): Hamiltonian whose ground state we want to find.</span>
<span class="sd">        ansatz (str): Optional, name of ansatz quantum circuit to use,</span>
<span class="sd">                      default=&#39;EfficientSU2&#39;</span>
<span class="sd">        ansatz_config (dict): Optional, configuration parameters for the</span>
<span class="sd">                              ansatz circuit.</span>
<span class="sd">        x0 (array_like): Optional, initial vector of parameters.</span>
<span class="sd">        optimizer (str): Optional, string specifying classical optimizer,</span>
<span class="sd">                         default=&#39;SPSA&#39;.</span>
<span class="sd">        optimizer_config (dict): Optional, configuration parameters for the</span>
<span class="sd">                                 optimizer.</span>
<span class="sd">        shots (int): Optional, number of shots to take per circuit.</span>
<span class="sd">        use_measurement_mitigation (bool): Optional, use measurement mitigation,</span>
<span class="sd">                                           default=False.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        OptimizeResult: The result in SciPy optimization format.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Split the Hamiltonian into two arrays, one for coefficients, the other for</span>
    <span class="c1"># operator strings</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hamiltonian</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">op_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hamiltonian</span><span class="p">]</span>
    <span class="c1"># The number of qubits needed is given by the number of elements in the strings</span>
    <span class="c1"># the defiune the Hamiltonian. Here we grab this data from the first element.</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># We grab the requested ansatz circuit class from the Qiskit circuit library</span>
    <span class="c1"># n_local module and configure it using the number of qubits and options</span>
    <span class="c1"># passed in the ansatz_config.</span>
    <span class="n">ansatz_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lib_local</span><span class="p">,</span> <span class="n">ansatz</span><span class="p">)</span>
    <span class="n">ansatz_circuit</span> <span class="o">=</span> <span class="n">ansatz_instance</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="o">**</span><span class="n">ansatz_config</span><span class="p">)</span>
    
    <span class="c1"># Here we use our convenence function from Appendix B to get measurement circuits</span>
    <span class="c1"># with the correct single-qubit rotation gates.</span>
    <span class="n">meas_circs</span> <span class="o">=</span> <span class="n">opstr_to_meas_circ</span><span class="p">(</span><span class="n">op_strings</span><span class="p">)</span>
    
    <span class="c1"># When computing the expectation value for the energy, we need to know if we</span>
    <span class="c1"># evaluate a Z measurement or and identity measurement.  Here we take and X and Y</span>
    <span class="c1"># operator in the strings and convert it to a Z since we added the rotations</span>
    <span class="c1"># with the meas_circs.</span>
    <span class="n">meas_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">op_strings</span><span class="p">]</span>
    
    <span class="c1"># Take the ansatz circuits, add the single-qubit measurement basis rotations from</span>
    <span class="c1"># meas_circs, and finally append the measurements themselves.</span>
    <span class="n">full_circs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ansatz_circuit</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">mcirc</span><span class="p">)</span><span class="o">.</span><span class="n">measure_all</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">mcirc</span> <span class="ow">in</span> <span class="n">meas_circs</span><span class="p">]</span>
    
    <span class="c1"># Get the number of parameters in the ansatz circuit.</span>
    <span class="n">num_params</span> <span class="o">=</span> <span class="n">ansatz_circuit</span><span class="o">.</span><span class="n">num_parameters</span>
    
    <span class="c1"># Use a given initial state, if any, or do random initial state.</span>
    <span class="k">if</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of params in x0 (</span><span class="si">{}</span><span class="s1">) does not match number </span><span class="se">\</span>
<span class="s1">                              of ansatz parameters (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                 <span class="n">num_params</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_params</span><span class="p">)</span>
        
    <span class="c1"># Because we are in general targeting a real quantum system, our circuits must be transpiled</span>
    <span class="c1"># to match the system topology and, hopefully, optimize them.</span>
    <span class="c1"># Here we will set the transpiler to the most optimal settings where &#39;sabre&#39; layout and</span>
    <span class="c1"># routing are used, along with full O3 optimization.</span>

    <span class="c1"># This works around a bug in Qiskit where Sabre routing fails for simulators (Issue #7098)</span>
    <span class="n">trans_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">backend</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">simulator</span><span class="p">:</span>
        <span class="n">trans_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;layout_method&#39;</span><span class="p">:</span> <span class="s1">&#39;sabre&#39;</span><span class="p">,</span> <span class="s1">&#39;routing_method&#39;</span><span class="p">:</span> <span class="s1">&#39;sabre&#39;</span><span class="p">}</span>
    <span class="n">trans_circs</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">full_circs</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">optimization_level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">trans_dict</span><span class="p">)</span>
    
    <span class="c1"># If using measurement mitigation we need to find out which physical qubits our transpiled</span>
    <span class="c1"># circuits actually measure, construct a mitigation object targeting our backend, and</span>
    <span class="c1"># finally calibrate our mitgation by running calibration circuits on the backend.</span>
    <span class="k">if</span> <span class="n">use_measurement_mitigation</span><span class="p">:</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="n">mthree</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">final_measurement_mapping</span><span class="p">(</span><span class="n">trans_circs</span><span class="p">)</span>
        <span class="n">mit</span> <span class="o">=</span> <span class="n">mthree</span><span class="o">.</span><span class="n">M3Mitigation</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">mit</span><span class="o">.</span><span class="n">cals_from_system</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
    
    <span class="c1"># Here we define a callback function that will stream the optimizer parameter vector</span>
    <span class="c1"># back to the user after each iteration.  This uses the `user_messenger` object.</span>
    <span class="c1"># Here we convert to a list so that the return is user readable locally, but</span>
    <span class="c1"># this is not required.</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">xk</span><span class="p">):</span>
        <span class="n">user_messenger</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">xk</span><span class="p">))</span>
    
    <span class="c1"># This is the primary VQE function executed by the optimizer. This function takes the </span>
    <span class="c1"># parameter vector as input and returns the energy evaluated using an ansatz circuit</span>
    <span class="c1"># bound with those parameters.</span>
    <span class="k">def</span> <span class="nf">vqe_func</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="c1"># Attach (bind) parameters in params vector to the transpiled circuits.</span>
        <span class="n">bound_circs</span> <span class="o">=</span> <span class="p">[</span><span class="n">circ</span><span class="o">.</span><span class="n">bind_parameters</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">for</span> <span class="n">circ</span> <span class="ow">in</span> <span class="n">trans_circs</span><span class="p">]</span>
        
        <span class="c1"># Submit the job and get the resultant counts back</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">bound_circs</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
        
        <span class="c1"># If using measurement mitigation apply the correction and</span>
        <span class="c1"># compute expectation values from the resultant quasiprobabilities</span>
        <span class="c1"># using the measurement strings.</span>
        <span class="k">if</span> <span class="n">use_measurement_mitigation</span><span class="p">:</span>
            <span class="n">quasi_collection</span> <span class="o">=</span> <span class="n">mit</span><span class="o">.</span><span class="n">apply_correction</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">maps</span><span class="p">)</span>
            <span class="n">expvals</span> <span class="o">=</span> <span class="n">quasi_collection</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">meas_strings</span><span class="p">)</span>
        <span class="c1"># If not doing any mitigation just compute expectation values</span>
        <span class="c1"># from the raw counts using the measurement strings.</span>
        <span class="c1"># Since Qiskit does not have such functionality we use the convenence</span>
        <span class="c1"># function from the mthree mitigation module.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expvals</span> <span class="o">=</span> <span class="n">mthree</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">meas_strings</span><span class="p">)</span>
        
        <span class="c1"># The energy is computed by simply taking the product of the coefficients</span>
        <span class="c1"># and the computed expectation values and summing them. Here we also</span>
        <span class="c1"># take just the real part as the coefficients can possibly be complex,</span>
        <span class="c1"># but the energy (eigenvalue) of a Hamiltonian is always real.</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeffs</span><span class="o">*</span><span class="n">expvals</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">energy</span>
    
    <span class="c1"># Here is where we actually perform the computation.  We begin by seeing what</span>
    <span class="c1"># optimization routine the user has requested, eg. SPSA verses SciPy ones,</span>
    <span class="c1"># and dispatch to the correct optimizer.  The selected optimizer starts at</span>
    <span class="c1"># x0 and calls &#39;vqe_func&#39; everytime the optimizer needs to evaluate the cost</span>
    <span class="c1"># function.  The result is returned as a SciPy OptimizerResult object.</span>
    <span class="c1"># Additionally, after every iteration, we use the &#39;callback&#39; function to</span>
    <span class="c1"># publish the interm results back to the user. This is important to do</span>
    <span class="c1"># so that if the Program terminates unexpectedly, the user can start where they</span>
    <span class="c1"># left off.</span>
    
    <span class="c1"># Since SPSA is not in SciPy need if statement</span>
    <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;SPSA&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fmin_spsa</span><span class="p">(</span><span class="n">vqe_func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">optimizer_config</span><span class="p">,</span>
                        <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
    <span class="c1"># All other SciPy optimizers here</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">vqe_func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                           <span class="n">options</span><span class="o">=</span><span class="n">optimizer_config</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
    <span class="c1"># Return result. OptimizeResult is a subclass of dict.</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="local-testing">
<h2>Local testing<a class="headerlink" href="#local-testing" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-info">
<b>Important:</b> You need to execute the code blocks in Appendices A and B before continuing.
</div>
<p>We can test whether our routine works by simply calling the <code class="docutils literal notranslate"><span class="pre">main</span></code> function with a backend instance, a <code class="docutils literal notranslate"><span class="pre">UserMessenger</span></code>, and sample arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit.providers.ibmq.runtime</span> <span class="kn">import</span> <span class="n">UserMessenger</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">UserMessenger</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the local Aer simulator</span>
<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">Aer</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;qasm_simulator&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute the main routine for our simple two-qubit Hamiltonian H, and perform 5 iterations of the SPSA solver.</span>
<span class="n">main</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.419780432710152, 2.3984284215892018, 1.1306533554149105, 1.8357672762510684, 5.414120644000338, 6.107301966755861, -0.013391355872252708, 5.615586607539193, 4.211781149943555, 1.792388243059789, 4.203949657158362, 0.1038271369149637, 2.4220098073658884, 4.617958787629208, 2.9969591661895865, 1.5490655190231735]
[2.1084925021737537, 3.0871404910528035, 0.4419412859513089, 2.52447934571467, 4.725408574536736, 5.418589897292259, -0.7021034253358543, 6.3042986770027944, 3.523069080479953, 1.1036761735961873, 3.5152375876947604, 0.7925392063785653, 3.11072187682949, 5.30667085709281, 3.685671235653188, 0.8603534495595718]
[1.7365578685005831, 3.459075124725974, 0.8138759196244794, 2.8964139793878405, 4.353473940863566, 5.046655263619089, -1.0740380590090248, 5.932364043329624, 3.1511344468067826, 1.475610807269358, 3.8871722213679307, 1.1644738400517358, 2.73878724315632, 4.934736223419639, 4.057605869326359, 1.2322880832327423]
[1.7839871181735734, 3.4116458750529834, 0.766446669951489, 2.84898472971485, 4.306044691190576, 5.094084513292079, -1.0266088093360346, 5.884934793656634, 3.198563696479773, 1.5230400569423481, 3.8397429716949403, 1.1170445903787456, 2.6913579934833294, 4.887306973746649, 4.105035118999349, 1.2797173329057325]
[1.122687940285629, 4.072945052940928, 1.4277458478394336, 2.1876855518269056, 3.6447455133026314, 5.755383691180024, -1.687907987223979, 6.546233971544579, 2.5372645185918286, 2.1843392348302926, 4.501042149582885, 1.7783437682666903, 3.352657171371274, 4.226007795858704, 4.766334296887294, 0.618418155017788]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.72705078125
 message: &#39;Optimization terminated successfully.&#39;
    nfev: 10
     nit: 5
 success: True
       x: array([ 1.12268794,  4.07294505,  1.42774585,  2.18768555,  3.64474551,
        5.75538369, -1.68790799,  6.54623397,  2.53726452,  2.18433923,
        4.50104215,  1.77834377,  3.35265717,  4.2260078 ,  4.7663343 ,
        0.61841816])
</pre></div>
</div>
</div>
</div>
<p>Having executed the above, we see that there are 5 parameter arrays returned, one for each callback, along with the final optimization result.  The parameter arrays are the interim results, and the <code class="docutils literal notranslate"><span class="pre">UserMessenger</span></code> object prints these values to the cell output.  The output itself is the answer we obtained, expressed as a SciPy <code class="docutils literal notranslate"><span class="pre">OptimizerResult</span></code> object.</p>
</section>
<section id="program-metadata">
<h2>Program metadata<a class="headerlink" href="#program-metadata" title="Permalink to this headline">#</a></h2>
<p>Program metadata is essentially the docstring for a runtime program.  It describes overall program information such as the program <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">description</span></code>, <code class="docutils literal notranslate"><span class="pre">version</span></code>, and the <code class="docutils literal notranslate"><span class="pre">max_execution_time</span></code> the program is allowed to run, as well as details the inputs and the outputs the program expects.  At a bare minimum the values described above are required</p>
<div class="alert alert-block alert-warning">
<b>Important:</b> As of the time of writing, runtime names must be unique amongst all users. Because of this, we will add a unique ID (UUID) to the program name.  This limitation will be removed in a future release.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>

<span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sample-vqe-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
  <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A sample VQE program.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;max_execution_time&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>It is important to set the <code class="docutils literal notranslate"><span class="pre">max_execution_time</span></code> high enough so that your program does not get terminated unexpectedly.  Additionally, one should make sure that interim results are sent back to the user so that, if something does happen, the user can start where they left off.</p>
<p>It is, however, good form to detail the parameters and return types, as well as interim results.  That being said, if making a runtime intended to be used by others, this information would also likely be mirrored in the signature of a function or class that the user would interact with directly; end users should not directly call runtime programs.  We will see why below.  Nevertheless, let us add to our metadata.  First, the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> section details the inputs the user is able to pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hamiltonian&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Hamiltonian whose ground state we want to find.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ansatz&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of ansatz quantum circuit to use, default=&#39;EfficientSU2&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ansatz_config&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Configuration parameters for the ansatz circuit.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Initial vector of parameters.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ndarray&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Classical optimizer to use, default=&#39;SPSA&#39;.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Configuration parameters for the optimizer.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;shots&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Number of shots to take per circuit.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;use_measurement_mitigation&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Use measurement mitigation, default=False.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Next, the <code class="docutils literal notranslate"><span class="pre">return_values</span></code> section tells about the return types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;return_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Final result in SciPy optimizer format.&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;OptimizeResult&quot;</span><span class="p">}</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>and finally let us specify what comes back when an interim result is returned:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;interim_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Parameter vector at current optimization step&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ndarray&quot;</span><span class="p">},</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="uploading-the-program">
<h2>Uploading the program<a class="headerlink" href="#uploading-the-program" title="Permalink to this headline">#</a></h2>
<p>We now have all the ingredients needed to upload our program.  To do so we need to collect all of our code in one file, here called <code class="docutils literal notranslate"><span class="pre">sample_vqe.py</span></code> for uploading.  This limitation will be removed in later versions of Qiskit Runtime.  Alternatively, if the entire code is contained within a single Jupyter notebook cell, this can be done using the magic function</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">my_program</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>To actually upload the program we need to get a Provider from our IBM Quantum account:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">IBMQ</span>
<span class="n">IBMQ</span><span class="o">.</span><span class="n">load_account</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AccountProvider for IBMQ(hub=&#39;ibm-q&#39;, group=&#39;open&#39;, project=&#39;main&#39;)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">provider</span> <span class="o">=</span> <span class="n">IBMQ</span><span class="o">.</span><span class="n">get_provider</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;deployed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="program-upload">
<h3>Program upload<a class="headerlink" href="#program-upload" title="Permalink to this headline">#</a></h3>
<p>The call to <code class="docutils literal notranslate"><span class="pre">program_upload</span></code> takes the target Python file as <code class="docutils literal notranslate"><span class="pre">data</span></code> and the metadata as inputs. <strong>If you have already uploaded the program this will raise an error and you must delete it first to continue</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">program_id</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">upload_program</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;sample_vqe.py&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
<span class="n">program_id</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;sample-vqe-1c65cfd4-9551-42fc-bfbe-099e7fd2574f&#39;
</pre></div>
</div>
</div>
</div>
<p>Here the returned <code class="docutils literal notranslate"><span class="pre">program_id</span></code> is the same as the program <code class="docutils literal notranslate"><span class="pre">name</span></code> given in the metadata.  You cannot have more than one program with the same <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">program_id</span></code>.  The <code class="docutils literal notranslate"><span class="pre">program_id</span></code> is how you should reference your program.</p>
</section>
<section id="program-information">
<h3>Program information<a class="headerlink" href="#program-information" title="Permalink to this headline">#</a></h3>
<p>We can query the program for information and see that our metadata is correctly being attached:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prog</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">program_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sample-vqe-1c65cfd4-9551-42fc-bfbe-099e7fd2574f:
  Name: sample-vqe-1c65cfd4-9551-42fc-bfbe-099e7fd2574f
  Description: A sample VQE program.
  Version: 1.0
  Creation date: 2021-10-06T22:21:05.000000
  Max execution time: 100000
  Input parameters:
    - hamiltonian:
      Description: Hamiltonian whose ground state we want to find.
      Type: list
      Required: True
    - ansatz:
      Description: Name of ansatz quantum circuit to use, default=&#39;EfficientSU2&#39;
      Type: str
      Required: False
    - ansatz_config:
      Description: Configuration parameters for the ansatz circuit.
      Type: dict
      Required: False
    - x0:
      Description: Initial vector of parameters.
      Type: ndarray
      Required: False
    - optimizer:
      Description: Classical optimizer to use, default=&#39;SPSA&#39;.
      Type: str
      Required: False
    - optimizer_config:
      Description: Configuration parameters for the optimizer.
      Type: dict
      Required: False
    - shots:
      Description: Number of shots to take per circuit.
      Type: int
      Required: False
    - use_measurement_mitigation:
      Description: Use measurement mitigation, default=False.
      Type: bool
      Required: False
  Interim results:
    - params:
      Description: Parameter vector at current optimization step
      Type: ndarray
  Returns:
    - result:
      Description: Final result in SciPy optimizer format.
      Type: OptimizeResult
</pre></div>
</div>
</div>
</div>
</section>
<section id="deleting-a-program">
<h3>Deleting a program<a class="headerlink" href="#deleting-a-program" title="Permalink to this headline">#</a></h3>
<p>If you make a mistake and need to delete and/or re-upload the program, you can run the following, passing the <code class="docutils literal notranslate"><span class="pre">program_id</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#provider.runtime.delete_program(program_id)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="running-the-program">
<h2>Running the program<a class="headerlink" href="#running-the-program" title="Permalink to this headline">#</a></h2>
<section id="specify-parameters">
<h3>Specify parameters<a class="headerlink" href="#specify-parameters" title="Permalink to this headline">#</a></h3>
<p>To run the program we need to specify the <code class="docutils literal notranslate"><span class="pre">options</span></code> that are used in the runtime environment (not the program variables).  At present, only the <code class="docutils literal notranslate"><span class="pre">backend_name</span></code> is required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ibmq_qasm_simulator</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;backend_name&#39;</span><span class="p">:</span> <span class="n">backend</span><span class="o">.</span><span class="n">name</span><span class="p">()}</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">inputs</span></code> dictionary is used to pass arguments to the <code class="docutils literal notranslate"><span class="pre">main</span></code> function itself.  For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
<span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;optimizer_config&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="execute-the-program">
<h3>Execute the program<a class="headerlink" href="#execute-the-program" title="Permalink to this headline">#</a></h3>
<p>We now can execute the program and grab the result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;fun&#39;: -1.93994140625,
 &#39;x&#39;: array([-1.28984461,  3.73974929,  3.52327612,  1.74979783,  3.13519544,
         2.43577395,  1.30425595,  0.04847941,  6.17766827,  1.92879213,
         1.95707213,  2.8097762 ,  1.95108352,  1.20067124,  7.01868106,
         4.36507161]),
 &#39;nit&#39;: 10,
 &#39;nfev&#39;: 20,
 &#39;message&#39;: &#39;Optimization terminated successfully.&#39;,
 &#39;success&#39;: True}
</pre></div>
</div>
</div>
</div>
<p>A few things need to be pointed out. First, we did not get back any interim results, and second, the return object is a plain dictionary.  This is because we did not listen for the return results, and we did not tell the job how to format the return result.</p>
</section>
<section id="listening-for-interim-results">
<h3>Listening for interim results<a class="headerlink" href="#listening-for-interim-results" title="Permalink to this headline">#</a></h3>
<p>To listen for interm results we need to pass a callback function to <code class="docutils literal notranslate"><span class="pre">provider.runtime.run</span></code> that stores the results.  The callback takes two arguments <code class="docutils literal notranslate"><span class="pre">job_id</span></code> and the returned data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interm_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">def</span> <span class="nf">vqe_callback</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">interm_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Executing again we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job2</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">vqe_callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job2</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;fun&#39;: -2.635986328125,
 &#39;x&#39;: array([ 1.39625003,  3.10967996,  2.46291361, -0.09150619,  1.89013366,
         0.48872864,  5.60656903,  1.12770301,  4.04603538,  2.85551118,
         0.45677689,  3.46054286,  4.10740117,  4.163728  ,  1.53949656,
         3.46634995]),
 &#39;nit&#39;: 10,
 &#39;nfev&#39;: 20,
 &#39;message&#39;: &#39;Optimization terminated successfully.&#39;,
 &#39;success&#39;: True}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">interm_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1.1839280526666394, 2.391820224610454, 2.7491281736833244, 0.5771768054969294, 2.349087960882593, 0.20251406828095217, 5.3527505036344865, 1.80726551800796, 2.8686317344166947, 2.4545878612072003, -0.04047464122825306, 4.2780676963333795, 3.27599724292225, 3.5527489679560844, 2.1472927005219273, 3.1637626657075555], [1.1855194978035488, 2.3902287794735444, 2.750719618820234, 0.5755853603600198, 2.3506794060195024, 0.20092262314404263, 5.351159058497577, 1.8088569631448694, 2.870223179553604, 2.452996416070291, -0.04206608636516258, 4.27647625119647, 3.2775886880591596, 3.554340413092994, 2.148884145658837, 3.165354110844465], [1.0411904999135912, 2.534557777363502, 2.8950486167101914, 0.7199143582499773, 2.206350408129545, 0.05659362525408518, 5.206830060607619, 1.664527965254912, 3.0145521774435617, 2.5973254139602484, 0.10226291152479487, 4.420805249086427, 3.133259690169202, 3.6986694109829514, 2.004555147768879, 3.0210251129545074], [1.005580093753927, 2.5701681835231662, 2.9306590228698557, 0.7555247644096416, 2.241960814289209, 0.020983219094420913, 5.242440466767284, 1.7001383714145764, 3.050162583603226, 2.561715007800584, 0.13787331768445915, 4.456415655246091, 3.0976492840095378, 3.663059004823287, 2.0401655539285435, 3.0566355191141716], [1.07047876838977, 2.6350668581590093, 2.8657603482340126, 0.8204234390454845, 2.177062139653366, 0.08588189373026392, 5.307339141403126, 1.6352396967787333, 2.985263908967383, 2.496816333164741, 0.20277199232030216, 4.521314329881934, 3.162547958645381, 3.7279576794591303, 1.9752668792927004, 2.9917368444783285], [1.3994411335364108, 2.96402922330565, 3.1947227133806533, 0.4914610738988439, 2.5060245048000067, -0.2430804714163767, 5.636301506549767, 1.3062773316320926, 3.3142262741140236, 2.8257786983113817, -0.12619037282633846, 4.192351964735293, 3.4915103237920215, 3.3989953143124896, 2.304229244439341, 3.3206992096249692], [1.325020213130704, 3.0384501437113567, 3.1203017929749466, 0.5658819943045507, 2.5804454252057134, -0.16865955101066996, 5.710722426955474, 1.231856411226386, 3.3886471945197303, 2.751357777905675, -0.2006112932320452, 4.117931044329586, 3.417089403386315, 3.4734162347181963, 2.2298083240336344, 3.395120130030676], [1.031941029864989, 2.7453709604456416, 2.8272226097092314, 0.2728028110388356, 2.2873662419399983, 0.12441963225504513, 6.003801610221189, 1.524935594492101, 3.6817263777854454, 2.45827859463996, 0.09246789003366987, 3.8248518610638707, 3.71016858665203, 3.7664954179839114, 1.9367291407679192, 3.102040946764961], [1.4127118235825624, 3.126141754163215, 2.446451815991658, -0.10796798267873797, 1.9065954482224248, 0.5051904259726187, 5.623030816503616, 1.1441648007745275, 4.062497171503019, 2.8390493883575334, 0.47323868375124345, 3.444081067346297, 4.090939380369604, 4.147266211701485, 1.5559583470503457, 3.4828117404825343], [1.3962500340466297, 3.1096799646272824, 2.4629136055275906, -0.09150619314280523, 1.890133658686492, 0.4887286364366859, 5.606569026967683, 1.1277030112385948, 4.046035381967086, 2.855511177893466, 0.4567768942153107, 3.46054285688223, 4.107401169905537, 4.163728001237418, 1.539496557514413, 3.4663499509466016]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="formatting-the-returned-results">
<h3>Formatting the returned results<a class="headerlink" href="#formatting-the-returned-results" title="Permalink to this headline">#</a></h3>
<p>In order to format the return results into the desired format, we need to specify a decoder.  This decoder must have a <code class="docutils literal notranslate"><span class="pre">decode</span></code> method that gets called to do the actual conversion.  In our case <code class="docutils literal notranslate"><span class="pre">OptimizeResult</span></code> is a simple sub-class of <code class="docutils literal notranslate"><span class="pre">dict</span></code> so the formatting is simple.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit.providers.ibmq.runtime</span> <span class="kn">import</span> <span class="n">ResultDecoder</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>

<span class="k">class</span> <span class="nc">VQEResultDecoder</span><span class="p">(</span><span class="n">ResultDecoder</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># This is required to preformat the data returned.</span>
        <span class="k">return</span> <span class="n">OptimizeResult</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can then use this when returning the job result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job3</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">job3</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">decoder</span><span class="o">=</span><span class="n">VQEResultDecoder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -0.645751953125
 message: &#39;Optimization terminated successfully.&#39;
    nfev: 20
     nit: 10
 success: True
       x: array([ 5.72140052,  2.29687026,  4.13837683,  3.22216958,  4.76184762,
        1.20943004,  5.74244574,  2.22665936,  4.34308411,  3.8390838 ,
       -0.50949471,  2.15587397,  3.19045035,  5.82751179,  1.95972168,
        3.75821819])
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="simplifying-program-execution-with-wrapping-functions">
<h2>Simplifying program execution with wrapping functions<a class="headerlink" href="#simplifying-program-execution-with-wrapping-functions" title="Permalink to this headline">#</a></h2>
<p>While runtime programs are powerful and flexible, they are not the most friendly things to interact with.  Therefore, if your program is intended to be used by others, it is best to make wrapper functions and/or classes that simplify the user experience.  Moreover, such wrappers allow for validation of user inputs on the client side, which can quickly find errors that would otherwise be raised later during the execution process - something that might have taken hours waiting in queue to get to.</p>
<p>Here we will make two helper routines.  First, a job wrapper that allows us to attach and retrieve the interim results directly from the job object itself, as well as decodes for us so that the end user need not worry about formatting the results themselves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RuntimeJobWrapper</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A simple Job wrapper that attaches interm results directly to the job object itself</span>
<span class="sd">    in the `interm_results attribute` via the `_callback` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decoder</span> <span class="o">=</span> <span class="n">VQEResultDecoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interm_results</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">xk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The callback function that attaches interm results:</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">            job_id (str): The job ID.</span>
<span class="sd">            xk (array_like): A list or NumPy array to attach.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interm_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Class does not have </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the result of the job as a SciPy OptimizerResult object.</span>
<span class="sd">        </span>
<span class="sd">        This blocks until job is done, cancelled, or errors.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            OptimizerResult: A SciPy optimizer result object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_decoder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we create the actual function we want users to call to execute our program.  To this function we will add a series of simple validation checks (not all checks will be done for simplicity), as well as use the job wrapper defined above to simply the output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">qiskit.circuit.library.n_local</span> <span class="k">as</span> <span class="nn">lib_local</span>

<span class="k">def</span> <span class="nf">vqe_runner</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span>
               <span class="n">ansatz</span><span class="o">=</span><span class="s1">&#39;EfficientSU2&#39;</span><span class="p">,</span> <span class="n">ansatz_config</span><span class="o">=</span><span class="p">{},</span>
               <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;SPSA&#39;</span><span class="p">,</span>
               <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
               <span class="n">shots</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
               <span class="n">use_measurement_mitigation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Routine that executes a given VQE problem via the sample-vqe program on the target backend.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        backend (ProgramBackend): Qiskit backend instance.</span>
<span class="sd">        hamiltonian (list): Hamiltonian whose ground state we want to find.</span>
<span class="sd">        ansatz (str): Optional, name of ansatz quantum circuit to use, default=&#39;EfficientSU2&#39;</span>
<span class="sd">        ansatz_config (dict): Optional, configuration parameters for the ansatz circuit.</span>
<span class="sd">        x0 (array_like): Optional, initial vector of parameters.</span>
<span class="sd">        optimizer (str): Optional, string specifying classical optimizer, default=&#39;SPSA&#39;.</span>
<span class="sd">        optimizer_config (dict): Optional, configuration parameters for the optimizer.</span>
<span class="sd">        shots (int): Optional, number of shots to take per circuit.</span>
<span class="sd">        use_measurement_mitigation (bool): Optional, use measurement mitigation, default=False.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        OptimizeResult: The result in SciPy optimization format.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;backend_name&#39;</span><span class="p">:</span> <span class="n">backend</span><span class="o">.</span><span class="n">name</span><span class="p">()}</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Validate Hamiltonian is correct</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ham</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hamiltonian</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ham</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">num_qubits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of qubits in Hamiltonian term </span><span class="si">{}</span><span class="s1"> does not match </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span>
                                                                                                <span class="n">num_qubits</span><span class="p">))</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hamiltonian</span>
    
    <span class="c1"># Validate ansatz is in the module</span>
    <span class="n">ansatz_circ</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lib_local</span><span class="p">,</span> <span class="n">ansatz</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ansatz_circ</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ansatz </span><span class="si">{}</span><span class="s1"> not in n_local circuit library.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ansatz</span><span class="p">))</span>
        
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;ansatz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ansatz</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;ansatz_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ansatz_config</span>
    
    <span class="c1"># If given x0, validate its length against num_params in ansatz:</span>
    <span class="k">if</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">ansatz_circ</span> <span class="o">=</span> <span class="n">ansatz_circ</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="o">**</span><span class="n">ansatz_config</span><span class="p">)</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="n">ansatz_circ</span><span class="o">.</span><span class="n">num_parameters</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Length of x0 </span><span class="si">{}</span><span class="s1"> does not match number of params in ansatz </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                                   <span class="n">num_params</span><span class="p">))</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>
    
    <span class="c1"># Set the rest of the inputs</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;optimizer_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_config</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;shots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shots</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;use_measurement_mitigation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_measurement_mitigation</span>
    
    <span class="n">rt_job</span> <span class="o">=</span> <span class="n">RuntimeJobWrapper</span><span class="p">()</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">rt_job</span><span class="o">.</span><span class="n">_callback</span><span class="p">)</span>
    <span class="n">rt_job</span><span class="o">.</span><span class="n">_job</span> <span class="o">=</span> <span class="n">job</span>
    
    <span class="k">return</span> <span class="n">rt_job</span>
    
</pre></div>
</div>
</div>
</div>
<p>We can now execute our runtime program via this runner function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job4</span> <span class="o">=</span> <span class="n">vqe_runner</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job4</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.349853515625
 message: &#39;Optimization terminated successfully.&#39;
    nfev: 30
     nit: 15
 success: True
       x: array([0.09925502, 1.40473727, 1.61291267, 3.45519813, 2.65167136,
       4.4163485 , 1.98523376, 5.94459488, 6.46103911, 1.76878845,
       1.96124064, 3.31830748, 2.06192779, 4.28293342, 3.2448137 ,
       1.63457609])
</pre></div>
</div>
</div>
</div>
<p>The interim results are now attached to the job <code class="docutils literal notranslate"><span class="pre">interm_results</span></code> attribute and, as expected, we see that the length matches the number of iterations performed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">job4</span><span class="o">.</span><span class="n">interm_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15
</pre></div>
</div>
</div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">#</a></h2>
<p>We have demonstrated how to create, upload, and use a custom Qiskit Runtime by creating our own VQE solver from scratch.  This tutorial was meant to touch upon every aspect of the process for a real-world example.  Within the current limitations of the runtime environment, this example should enable readers to develop their own single-file runtime program.  This program is also a good starting point for exploring additional flavors of VQE runtime.  For example, it is straightforward to vary the number of shots per iteration, increasing shots as the number of iterations increases.  Those looking to go deeper can consider implimenting an <a class="reference external" href="https://doi.org/10.1038/s41467-019-10988-2">adaptive VQE</a>, where the ansatz is not fixed at initialization.</p>
</section>
<section id="appendix-a">
<h2>Appendix A<a class="headerlink" href="#appendix-a" title="Permalink to this headline">#</a></h2>
<p>Here we code a simple simultaneous perturbation stochastic approximation (SPSA) optimizer for use on noisy quantum systems.  Most optimizers do not handle fluctuating cost functions well, so this is a needed addition for executing on real quantum hardware.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>

<span class="k">def</span> <span class="nf">fmin_spsa</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
              <span class="n">a</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.602</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.101</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimization of scalar function of one or more variables using simultaneous</span>
<span class="sd">    perturbation stochastic approximation (SPSA).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        func (callable): The objective function to be minimized.</span>

<span class="sd">                          ``fun(x, *args) -&gt; float``</span>

<span class="sd">                          where x is an 1-D array with shape (n,) and args is a</span>
<span class="sd">                          tuple of the fixed parameters needed to completely </span>
<span class="sd">                          specify the function.</span>

<span class="sd">        x0 (ndarray): Initial guess. Array of real elements of size (n,), </span>
<span class="sd">                      where â€˜nâ€™ is the number of independent variables.</span>
<span class="sd">      </span>
<span class="sd">        maxiter (int): Maximum number of iterations.  The number of function</span>
<span class="sd">                       evaluations is twice as many. Optional.</span>

<span class="sd">        a (float): SPSA gradient scaling parameter. Optional.</span>

<span class="sd">        alpha (float): SPSA gradient scaling exponent. Optional.</span>

<span class="sd">        c (float):  SPSA step size scaling parameter. Optional.</span>
<span class="sd">        </span>
<span class="sd">        gamma (float): SPSA step size scaling exponent. Optional.</span>

<span class="sd">        callback (callable): Function that accepts the current parameter vector</span>
<span class="sd">                             as input.</span>

<span class="sd">    Returns:</span>
<span class="sd">        OptimizeResult: Solution in SciPy Optimization format.</span>

<span class="sd">    Notes:</span>
<span class="sd">        See the `SPSA homepage &lt;https://www.jhuapl.edu/SPSA/&gt;`_ for usage and</span>
<span class="sd">        additional extentions to the basic version implimented here.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">maxiter</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>

    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">kk</span><span class="o">+</span><span class="mf">1.0</span><span class="o">+</span><span class="n">A</span><span class="p">)</span><span class="o">**-</span><span class="n">alpha</span>
        <span class="n">ck</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">kk</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**-</span><span class="n">gamma</span>
        <span class="c1"># Bernoulli distribution for randoms</span>
        <span class="n">deltak</span> <span class="o">=</span>  <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ck</span><span class="o">*</span><span class="n">deltak</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ck</span><span class="o">*</span><span class="n">deltak</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ck</span><span class="o">*</span><span class="n">deltak</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">ak</span><span class="o">*</span><span class="n">grad</span>
        
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">OptimizeResult</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">nit</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">nfev</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">maxiter</span><span class="p">,</span> 
                          <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Optimization terminated successfully.&#39;</span><span class="p">,</span>
                          <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="appendix-b">
<h2>Appendix B<a class="headerlink" href="#appendix-b" title="Permalink to this headline">#</a></h2>
<p>This is a helper function that converts the Pauli operators in the strings that define the Hamiltonian operators into the appropriate measurements at the end of the circuits.  For <span class="math notranslate nohighlight">\(X\)</span> operators this involves adding an <span class="math notranslate nohighlight">\(H\)</span> gate to the qubits to be measured, whereas a <span class="math notranslate nohighlight">\(Y\)</span> operator needs <span class="math notranslate nohighlight">\(S^{+}\)</span> followed by a <span class="math notranslate nohighlight">\(H\)</span>.  Other choices of Pauli operators require no additional gates prior to measurement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">opstr_to_meas_circ</span><span class="p">(</span><span class="n">op_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a list of operator strings and makes circuit with the correct post-rotations for measurements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        op_str (list): List of strings representing the operators needed for measurements.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of circuits for measurement post-rotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">circs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_str</span><span class="p">:</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">-</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">sdg</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">-</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">-</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">circs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit.tools.jupyter</span> <span class="kn">import</span> <span class="o">*</span>
<span class="o">%</span><span class="k">qiskit_copyright</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div style='width: 100%; background-color:#d5d9e0;padding-left: 10px; padding-bottom: 10px; padding-right: 10px; padding-top: 5px'><h3>This code is a part of Qiskit</h3><p>&copy; Copyright IBM 2017, 2021.</p><p>This code is licensed under the Apache License, Version 2.0. You may<br>obtain a copy of this license in the LICENSE.txt file in the root directory<br> of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.<p>Any modifications or derivative works of this code must retain this<br>copyright notice, and modified files need to carry a notice indicating<br>that they have been altered from the originals.</p></div></div></div>
</div>
</section>
</section>

<div class="section">
    

<div class="section">
  <span style="float: left">
    
  </span>
  <span>&nbsp;</span>
  <span style="float: right">
     
    <a href="2021-10-13-expval_program.html">
      Custom Expectation Value Program for the Qiskit Runtime <i
        class="fa fa-arrow-circle-right"
      ></i
      >
    </a>
    
  </span>
</div>
  
</div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, IBM Quantum.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>