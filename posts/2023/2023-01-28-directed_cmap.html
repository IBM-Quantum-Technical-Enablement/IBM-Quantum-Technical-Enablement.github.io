

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>How to make your backend a directed backend &#8212; Enabing Technologies  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-16824831-8"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-16824831-8');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'posts/2023/2023-01-28-directed_cmap';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>

<link
  rel="alternate"
  type="application/atom+xml"
  href="../../explore/atom.xml"
  title="Quantum Explorations"
/>



  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the site..."
         aria-label="Search the site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/dark_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../how-to/howto.html">
                        How to guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../explore.html">
                        Explorations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../hardware/hardware.html">
                        IBM Hardware
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../events.html">
                        Events
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../members.html">
                        Contributors
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the site..."
         aria-label="Search the site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/IBM-Quantum-Technical-Enablement" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../how-to/howto.html">
                        How to guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../explore.html">
                        Explorations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../hardware/hardware.html">
                        IBM Hardware
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../events.html">
                        Events
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../members.html">
                        Contributors
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the site..."
         aria-label="Search the site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/IBM-Quantum-Technical-Enablement" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__postcard">


<h2>
  
  
  <i class="fa fa-calendar"></i>
  
  28 January 2023
  
</h2>
<ul>
  

<li id="ablog-sidebar-item author ablog__author">
  <span>
    
    <i class="fa-fw fa fa-user"></i>
    
    </span>
  
  
  <a href="../../explore/author/paul-nation.html">Paul Nation</a>
  
  
  
</li>




<li id="ablog-sidebar-item category ablog__category">
  <span>
    
    <i class="fa-fw fa fa-folder-open"></i>
    
    </span>
  
  
  <a href="../../explore/category/hardware.html">Hardware</a>
  
  
  
</li>


<li id="ablog-sidebar-item tags ablog__tags">
  <span>
    
    
    <i class="fa-fw fa fa-tag"></i>
    
    </span>
  
  
  <a href="../../explore/tag/hardware.html">hardware</a>
  
  
  
</li>


</ul>
</div>
</div>
        <div class="sidebar-primary-item"><div class="dropdown-buttons">
    <!-- ipynb file if we had a myst markdown file -->
    
    <!-- Download raw file -->
    <a class="dropdown-buttons" href="../../_sources/posts/2023/2023-01-28-directed_cmap.ipynb.txt"><button type="button"
            class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
            data-placement="left">.ipynb</button></a>
</div></div>
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__recentposts">
<h3>
  <a href="../../explore.html">Recent Posts</a>
</h3>
<ul>
  
  
  <li>
    <a href="2023-05-24-Calibration_methods.html">
      24 May - Understanding IBM Quantum hardware calibration schemes
    </a>
  </li>
  
  <li>
    <a href="2023-05-12-properties_from_api.html">
      12 May - Accessing device properties without an IBM Quantum account
    </a>
  </li>
  
  <li>
    <a href="2023-02-02-pauli_twirling.html">
      02 February - Generating Pauli-twirled circuits in Qiskit
    </a>
  </li>
  
  <li>
    <a href="../2022/2022-11-07-challenge.html">
      07 November - Quantum Practitioners Forum 2022: CHSH Distance Challenge
    </a>
  </li>
  
  <li>
    <a href="../2022/2022-08-22-readout_mitigation.html">
      22 August - [BETA] Readout error mitigation in Runtime
    </a>
  </li>
  
</ul>
</div>
</div>
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__archive">
<h3>
  <a href="../../explore/archive.html">Archives</a>
</h3>
<ul>
  
  
  <li>
    <a href="../../explore/2023.html">2023 (4)</a>
  </li>
  
  
  
  <li>
    <a href="../../explore/2022.html">2022 (4)</a>
  </li>
  
  
  
  <li>
    <a href="../../explore/2021.html">2021 (5)</a>
  </li>
  
  
</ul>
</div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">How to make your backend a directed backend</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
<section class="tex2jax_ignore mathjax_ignore" id="how-to-make-your-backend-a-directed-backend">
<h1>How to make your backend a directed backend<a class="headerlink" href="#how-to-make-your-backend-a-directed-backend" title="Permalink to this heading">#</a></h1>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<p>Here we show the reader how to construct a directed IBM Quantum backend from an undirected one.  This yields some performance benefits as the Qiskit transpiler can better optimize single-qubit gates within the circuit.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="frontmatter">
<h1>Frontmatter<a class="headerlink" href="#frontmatter" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qiskit.providers</span> <span class="kn">import</span> <span class="n">BackendV1</span><span class="p">,</span> <span class="n">BackendV2</span>
<span class="kn">from</span> <span class="nn">qiskit.providers.fake_provider</span> <span class="kn">import</span> <span class="n">FakeAthens</span><span class="p">,</span> <span class="n">FakeAthensV2</span>
</pre></div>
</div>
</div>
</div>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this heading">#</a></h2>
<p>Recently IBM Quantum announced its new <a class="reference external" href="https://research.ibm.com/blog/eagle-quantum-error-mitigation">Sherbrooke device</a> that allows users to directly work with cross-resonance gates, and exposes only the natural direction that the gates operate in.  CNOT gates, which are comprised of cross-resonance gates on IBM Quantum systems, also have a natural direction, but current devices that use CNOT gates as their two-qubit basis gate do not directly express this directionality.  Indeed, the coupling map (topology) for these systems is symmetric / bi-directional; if you query the system you will see that it indicates that a backend can do a CNOT gate between qubits A &amp; B (control and target), as well as B &amp; A.  If a CX gate that is used in a circuit is not in the natural direction, the system will transparently flip it around in software and execute the circuit.  This comes with a cost however.  To see this, lets make a Bell state in the usual fashion (ignoring measurements for brevity):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e5dcfd9044e8af915d4469cdcc3105876785a0d7b60b4c63e0e64b29fa9ad38b.png" src="../../_images/e5dcfd9044e8af915d4469cdcc3105876785a0d7b60b4c63e0e64b29fa9ad38b.png" />
</div>
</div>
<p>If the background reports a symmetric coupling map, then this circuit will execute as is, with any differences in gate directionality handled internally.  Now suppose that the system we are targeting has a natural gate direction between qubits 0 and 1 that is in the opposite direction; The control must be qubit 1 and the target qubit 0.  What does the circuit being executed look like.  We can use the Qiskit transpiler to mimic this using the coupling map <code class="docutils literal notranslate"><span class="pre">coupling_map=</span> <span class="pre">[[1,</span> <span class="pre">0]]</span></code> and setting <code class="docutils literal notranslate"><span class="pre">optimization_level=0</span></code> since no optimization occurs down at the system level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trans_qc</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">coupling_map</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">optimization_level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">trans_qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2c11135a5e05261f92c77705704dceafa65c8d3f6009ca4d73571d9c8b8bf407.png" src="../../_images/2c11135a5e05261f92c77705704dceafa65c8d3f6009ca4d73571d9c8b8bf407.png" />
</div>
</div>
<p>One can immediately see from the figure above that the resulting circuit is less than optimized.  Indeed, it is already clear that we are missing the opportunity to collapse the two Hadamards into the identity.  If this circuit were embedded in a larger one, then the additional Hadamard gates could likely be combined with other single-qubit gates and optimized.  Thus if we expose the natural CNOT gate directions to Qiskit, we can gain some additional performance improvements. Even though single-qubit gate errors are ~100x lower than those of CNOT gates on IBM Quantum hardware, the savings can add up in larger circuits.</p>
<p>Below we will see how to turn any IBM Quantum backend that uses CNOT gates into a directed version using only the natural gate directions, allowing anyone to take advantage of the resulting performance improvements.</p>
</section>
<section id="convering-a-backend-to-a-directed-one">
<h2>Convering a backend to a directed one<a class="headerlink" href="#convering-a-backend-to-a-directed-one" title="Permalink to this heading">#</a></h2>
<p>If an IBM Quantum system returns a symmetric coupling map, how in the world are we going to figure out the natural gate directions?  It turns out that it is all in the timing information.  A CNOT gate in the natural direction has a set duration.  A CNOT gate in the opposite direction has a timing that is the sum of the natural direction time PLUS the time it takes to do the single qubit gates needed to reverse the direction.  So if we compare the CNOT gate time from A -&gt; B and B -&gt; A (control -&gt; target), whichever time is lower is the natural direction.  We can then reduce the coupling map down to just this set of natural gate directions.</p>
<p>At the time of writing, Qiskit and IBM Quantum are transitioning to a new version of the backend class structure called <code class="docutils literal notranslate"><span class="pre">BackendV2</span></code>.  However, <code class="docutils literal notranslate"><span class="pre">BackendV1</span></code> is still very much around, and we will make a function that converts both types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_directed_cx_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a directed CX gate backend.</span>
<span class="sd">    </span>
<span class="sd">    This yields a backend that allows CX gates only in their natural direction.</span>
<span class="sd">    This should yield somewhat better results as the transpiler can optimize</span>
<span class="sd">    a bit further.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        backend (BackendV1 or BackendV2): Input backend</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        BackendV1 or BackendV2: Directed version of input backend</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Backend must use cx gates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Make a copy of the backend so as to not mess up the original</span>
    <span class="n">directed_backend</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
    
    <span class="c1"># Backend V1</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">BackendV1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;cx&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">backend</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">basis_gates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Backend must use CX gates&#39;</span><span class="p">)</span>
        <span class="c1"># Grab coupling map and properties</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">coupling_map</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">directed_backend</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
        <span class="c1"># Make a dict of all the cx times</span>
        <span class="n">cx_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">:</span>
            <span class="n">cx_times</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">edge</span><span class="p">)]</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">gate_length</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
        <span class="c1"># Make new directed coupling map</span>
        <span class="n">directed_cmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cx_times</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cx_times</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cx_times</span><span class="p">[</span><span class="n">edge</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="n">directed_cmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span>
        
        <span class="c1"># Add directed version of coupling map</span>
        <span class="n">directed_backend</span><span class="o">.</span><span class="n">_configuration</span><span class="o">.</span><span class="n">coupling_map</span> <span class="o">=</span> <span class="n">directed_cmap</span>
        
        <span class="c1">#Remove unused cx gates from properties</span>
        <span class="n">dir_props</span> <span class="o">=</span> <span class="n">directed_backend</span><span class="o">.</span><span class="n">_properties</span>
        <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">dir_props</span><span class="o">.</span><span class="n">gates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">qubits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">qubits</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_cmap</span><span class="p">:</span>
                    <span class="n">dir_props</span><span class="o">.</span><span class="n">gates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
    
    <span class="c1"># Backend V2</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">BackendV2</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;cx&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_backend</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">operation_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Backend must use CX gates&#39;</span><span class="p">)</span>
        <span class="c1"># Get coupling map</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">coupling_map</span><span class="o">.</span><span class="n">get_edges</span><span class="p">()</span>
        <span class="c1"># Get all cx gates</span>
        <span class="n">cx_gates</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span>
        <span class="c1"># Generate directed coupling map</span>
        <span class="n">directed_cmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cx_gates</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span> <span class="o">&lt;</span> <span class="n">cx_gates</span><span class="p">[</span><span class="n">edge</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
                <span class="n">directed_cmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="c1"># Generate dict of directed cx edges only</span>
        <span class="n">cx_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">directed_backend</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">_gate_map</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">directed_cmap</span><span class="p">:</span>
                <span class="n">cx_dict</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">gate</span>
        <span class="c1"># Replace gate map with the directed gates only</span>
        <span class="n">directed_backend</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">_gate_map</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx_dict</span>
        <span class="c1"># Need to reset intenal _coupling_graph otherwise will not rebuild</span>
        <span class="n">directed_backend</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">_coupling_graph</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span>  <span class="n">directed_backend</span>
</pre></div>
</div>
</div>
</div>
<p>To see how this function works, let us create an instance of a fake backend of both V1 and V2 varieties:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend1</span> <span class="o">=</span> <span class="n">FakeAthens</span><span class="p">()</span>
<span class="n">backend2</span> <span class="o">=</span> <span class="n">FakeAthensV2</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">BackendV1</span></code> we can see the coupling map from the configuration information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend1</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">coupling_map</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0, 1], [1, 0], [1, 2], [2, 1], [2, 3], [3, 2], [3, 4], [4, 3]]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BackendV2</span></code> has the coupling map at the top of the class structure.  The coupling map does not have a <code class="docutils literal notranslate"><span class="pre">__repr__</span></code> so we need to print it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">backend2</span><span class="o">.</span><span class="n">coupling_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[4, 3], [3, 4], [2, 3], [3, 2], [1, 2], [2, 1], [1, 0], [0, 1]]
</pre></div>
</div>
</div>
</div>
<p>Regardless of version, you can see that for every entry in these lists, the reverse is also present; the coupling map is symmetric.  Lets see what our function gives us:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">directed_backend1</span> <span class="o">=</span> <span class="n">make_directed_cx_backend</span><span class="p">(</span><span class="n">backend1</span><span class="p">)</span>
<span class="n">directed_backend2</span> <span class="o">=</span> <span class="n">make_directed_cx_backend</span><span class="p">(</span><span class="n">backend2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">directed_backend1</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">coupling_map</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1, 0], [1, 2], [2, 3], [4, 3]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">directed_backend2</span><span class="o">.</span><span class="n">coupling_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[4, 3], [2, 3], [1, 2], [1, 0]]
</pre></div>
</div>
</div>
</div>
<p>We see that the coupling maps are no longer symmetric, and are indicating only the natural direction of the CNOT gates.</p>
<p>We can now use these in the transpiler, and reap the rewards:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">directed_trans_qc</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">directed_backend2</span><span class="p">)</span>
<span class="n">directed_trans_qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2da03cd0b1508237d7b1febacca8fbb8b1d554349d3662250c068d727789aa62.png" src="../../_images/2da03cd0b1508237d7b1febacca8fbb8b1d554349d3662250c068d727789aa62.png" />
</div>
</div>
<p>As expected, the transpiler can now optimize away the single-qubit gates that are added when reversing CNOT gate directions.</p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    <a href="../2022/2022-11-07-challenge.html">
      
      <i class="fa fa-arrow-circle-left"></i>
      
      <span>Quantum Practitioners Forum 2022: CHSH Distance Challenge</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    <a href="2023-02-02-pauli_twirling.html">
      <span>Generating Pauli-twirled circuits in Qiskit</span>
      
      <i class="fa fa-arrow-circle-right" ></i>
      
    </a>
    
  </span>
</div>

  
  
</div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">How to make your backend a directed backend</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#frontmatter">Frontmatter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convering-a-backend-to-a-directed-one">Convering a backend to a directed one</a></li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../../_sources/posts/2023/2023-01-28-directed_cmap.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

<footer class="bd-footer">
<div>
<p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Content on
        <a property="dct:title" rel="cc:attributionURL" href="http://quantum-enablement.org">this website</a> 
        by <span property="cc:attributionName">IBM</span> is licensed under 
        <a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
                Attribution-NonCommercial 4.0 International<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1">
                <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1">
                <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1">
        </a>
</p> 
</div>
</footer>

  </body>
</html>